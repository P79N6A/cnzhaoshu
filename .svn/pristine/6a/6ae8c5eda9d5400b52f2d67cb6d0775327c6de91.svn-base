<!DOCTYPE html>
<html>
  <head>
  <script>function getcookie(d){for(var b=document.cookie.split("; "),a=0;a<b.length;a++){var c=b[a].split("=");if(c[0]==d)return unescape(c[1])}}getcookie("user2")||location.replace("./login.html");
  </script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>苗店设置-找树网管理平台</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-reset.css" rel="stylesheet">

    <link href="../iconfont/iconfont.css" rel="stylesheet"/>

    <!-- Custom styles for this template -->
    <link href="css/style.css" rel="stylesheet">
    <link href="css/style-responsive.css" rel="stylesheet" />
    <link href="/summernote/summernote.css" rel="stylesheet">

    <link href="css/zhaoshu.css" rel="stylesheet">
    <style type="text/css">
      
      .tender,.danpin{
        width:50%;
        float: left;
        height:30px;
        text-align: center;
        line-height: 30px;
        font-size: 20px;
        border-radius: 5px;
      }
      .action{
        background: #ccc;
      }
      .top{
        position: fixed;
        z-index: 1002;
        top: 70px;
        width:86%;
        padding: 0 1%;
        height: 130px;
        background: #fff;
        border-radius: 5px;
      }
      .top1{
        float: left;
        height:40px;
        width: 100%;
        padding: 10px 0;
      }
      .top2{
        float: left;
        height:50px;
        width: 100%;
      }
      .top3{
        float: left;
        height: 40px;
        width: 100%;
      }
      .showorders{
        position: absolute;
        z-index: 100;
        top: 210px;
        width:86%;
        background: #fff;
        border-radius: 5px;
      }
      #showorders{
        width:100%;
        padding: 3px 1%;
        float: left;
        overflow-y: auto;
      }
      .tlow1{
        float: left;
        width:18%;
        height:40px;
        line-height: 40px;
        text-align: left;
        font-size: 16px;
        font-weight: bold;
      }
      .tlow2{
        float: left;
        width:12%;
        height:40px;
        line-height: 40px;
        text-align: left;
        font-size: 16px;
        font-weight: bold;
      }
      .tlow3{
        float: left;
        width:20%;
        height:40px;
        line-height: 40px;
        text-align: left;
        font-size: 16px;
        font-weight: bold;
      }
      .tlow4{
        float: left;
        width:11%;
        height:40px;
        line-height: 40px;
        text-align: right;
        font-size: 16px;
        font-weight: bold;
      }
      .low1{
        float: left;
        width:18%;
      }
      .low2{
        float: left;
        width:12%;
      }
      .low3{
        float: left;
        width:20%;
      }
      .low4{
        float: left;
        width:11%;
        text-align: right;
      }
      .oneinfo{
        border-bottom: 1px solid #eee;
        float: left;
        width: 100%;
        padding: 10px 0;
      }
      .oneinfo:hover{ 
        background-color:#eee;
      }
      .clean,.find{
        width:7%;
        height:29px;
        padding:0 1%;
        border-radius: 4px;
        float: left;
        margin-left: 1%;
        text-align: center;
        line-height: 28px;
        font-size: 18px;
        background: #ccc;
      }
      #tosearch{
        border:0;
        border-radius: 5px;
        width:83%;
        height:28px;
        padding-left:1%;
        float: left;
        color:#888;
        font-size: 16px;
        border:1px solid #ccc;
        border-radius: 5px;
      }
        
    </style>
  </head>

  <body>

    <header class="header white-bg" id="header"></header>
    <aside><div id="sidebar" class="nav-collapse"></div></aside>
    <section id="main-content">
      <section class="wrapper">
      <div class="top">
        <div class="top1">
          <input type="text" placeholder="可搜索：交易编号(不可少于12位)、用户名、电话号码" id="tosearch">
          <div class="clean">重置</div>
          <div class="find">搜索</div>
        </div>
        <div class="top2">
          <div class="tender action" style="height:30px;margin: 10px 0;">招标</div>
          <div class="danpin" style="height:30px;margin: 10px 0;">单品</div>
        </div>
        <div class="top3">
          <div class="tlow1">交易编号</div>
          <div class="tlow2">时间</div>
          <div class="tlow3">买方</div>
          <div class="tlow3">卖方</div>
          <div class="tlow4">定金</div>
          <div class="tlow4">全款</div>
        </div>
      </div>
        <div class="showorders">
          <div id="showorders">
          </div>
        </div>
      </section>
    </section>

    <script id="dot_order" type="text/x-dot-template">
      {{ for(var i in it) { }}
        <div class="oneinfo">
          <div class="low1">{{=it[i].serial_number}}</div>
          <div class="low2">{{=it[i].orderstart_time}}</div>
          <div class="low3">{{=it[i].tender_name +' '+ it[i].tender_phone}}</div>
          <div class="low3">{{=it[i].bid_name +' '+ it[i].bid_phone}}</div>
          <div class="low4">{{=(it[i].deposit)/100}}</div>
          <div class="low4">{{=payfull(it[i].fullamount,it[i].order_switch,it[i].state)}}</div>
        </div>
      {{ } }}
    </script>

    <script src="../js/jquery-1.12.4.min.js"></script>
    <script src="./js/login.js?t=20171017"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/jquery.scrollTo.min.js"></script>
    <script src="./js/jquery.nicescroll.js" type="text/javascript"></script>
    <script src="../js/doT.min.js"></script>
    <script src="./js/common-scripts.js"></script>

    <script type="text/javascript">
        var dot_order = doT.template($("#dot_order").text());
        var orders = [];
        var order_one = [];

        var searchorders = [];
        var searchorder_one = [];

        var isLoading = false;
        var isEnd = false;

        var searchisLoading = false;
        var searchisEnd = false;

        var windowheight = $(window).height();
        $('#showorders').css('height',(windowheight-220)+'px');

        loadorders();

        function loadorders(){
          if (isLoading) return;
          isLoading = true;
          var limit = $('#showorders .oneinfo').length + ',' + 20;
          $.getJSON('/com/orders_findpaylist.php',{limit:limit},function(json){
            if(json){
              $('#showorders').append(dot_order(json));
              for (var i = 0; i < json.length; i++) {
                orders[orders.length] = json[i];
              }
            }else{
                isEnd = true;
            }
            isLoading = false;
          })
        }

        function loadorder_one(){
          if (isLoading) return;
          isLoading = true;
          var limit = $('#showorders .oneinfo').length + ',' + 20;
          $.getJSON('/com/order_one_findpaylist.php',{limit:limit},function(json){
            if(json){
              $('#showorders').append(dot_order(json));
              for (var i = 0; i < json.length; i++) {
                order_one[order_one.length] = json[i];
              }
            }else{
                isEnd = true;
            }
            isLoading = false;
          })
        }

        $('.tender').click(function(){
          $('.action').removeClass('action');
          $('.tender').addClass('action');
          $('#showorders').html('');
          isLoading = false;
          isEnd = false;
          searchisLoading = false;
          searchisEnd = false;
          var tosearch = $('#tosearch').val();
          if(tosearch){
            if(!searchorders.length){
              search_list();
            }else{
              $('#showorders').html(dot_order(searchorders));
            }
          }else{
            if(!orders.length){
              loadorders();
            }else{
              $('#showorders').html(dot_order(orders));
            }
          }
        })

        $('.danpin').click(function(){
          $('.action').removeClass('action');
          $('.danpin').addClass('action');
          $('#showorders').html('');
          isLoading = false;
          isEnd = false;
          searchisLoading = false;
          searchisEnd = false;
          var tosearch = $('#tosearch').val();
          if(tosearch){
            if(!searchorder_one.length){
              search_lists();
            }else{
              $('#showorders').html(dot_order(searchorder_one));
            }
          }else{
            if(!order_one.length){
              loadorder_one();
            }else{
              $('#showorders').html(dot_order(order_one));
            }
          }
        })

        $('#showorders').scroll(function() {
          if($('.tender').hasClass('action')){
            if (isEnd || isLoading) return;
            var scrollHeight = $(this)[0].scrollHeight;
            var scrollTop = $(this)[0].scrollTop;
            var elementHight = $(this).height();
            if(scrollTop + elementHight >= scrollHeight-100) {
                if(tosearch){
                  search_list();
                }else{
                  loadorders();
                }
            } 
          }else{
            if (isEnd || isLoading) return;
            var scrollHeight = $(this)[0].scrollHeight;
            var scrollTop = $(this)[0].scrollTop;
            var elementHight = $(this).height();
            if(scrollTop + elementHight >= scrollHeight-100) {
                if(tosearch){
                  search_lists();
                }else{
                  loadorder_one();
                }
            } 
          }  
        })

        // 搜索平台
        $('#tosearch').on('keydown', function (e) {
          var key = e.which;
          if (key == 13) {
            e.preventDefault();
            var tosearch = $('#tosearch').val();
            if(!tosearch) return;
            $('#showorders').html('');
            if($('.tender').hasClass('action')){
              search_list();
            }else{
              search_lists();
            }
          }
        });

        $('.find').click(function () {
          var tosearch = $('#tosearch').val();
          if(!tosearch) return;
          $('#showorders').html('');
          if($('.tender').hasClass('action')){
            search_list();
          }else{
            search_lists();
          }
        });
        
        function search_list(){
          var tosearch = $('#tosearch').val();
          if(!tosearch) return;

          if (searchisLoading) return;
          searchisLoading = true;
          var limit = $('#showorders .oneinfo').length + ',' + 20;
          $.getJSON('/com/seach_transactpaylist.php', {name: tosearch,limit:limit}, function(json) {
            if(json){
              $('#showorders').append(dot_order(json));
              for (var i = 0; i < json.length; i++) {
                searchorders[searchorders.length] = json[i];
              }
            }else{
                if(searchorders.length){
                  $('#showorders').append('加载完毕');
                }else{
                  $('#showorders').append('未找到结果');
                }
                earchisEnd = true;
            }
            searchisLoading = false;
          })
        }

        function search_lists(){
          var tosearch = $('#tosearch').val();
          if(!tosearch) return;
          if (searchisLoading) return;
          searchisLoading = true;
          var limit = $('#showorders .oneinfo').length + ',' + 20;
          $.getJSON('/com/seach_transactpaylists.php', {name: tosearch,limit:limit}, function(json) {
            if(json){
              $('#showorders').append(dot_order(json));
              for (var i = 0; i < json.length; i++) {
                searchorder_one[searchorder_one.length] = json[i];
              }
            }else{
              if(searchorder_one.length){
                $('#showorders').append('加载完毕');
              }else{
                $('#showorders').append('未找到结果');
              }
              earchisEnd = true;
            }
            searchisLoading = false;
          })
        }

        function payfull(pfullamount,porder_switch,pstate){
          if((porder_switch == 1) && (pstate == 10)){
              return pfullamount;
          }else{
              return ' ';
          }
        }
        
        $('.clean').click(function(){
    			$('#showorders').html('');
    			$('#tosearch').val('');
    			if($('.tender').hasClass('action')){
      			if(!orders.length){
      			  loadorders();
      			}else{
      			  $('#showorders').html(dot_order(orders));
      			}
    			}else{
      			if(!order_one.length){
      			  loadorder_one();
      			}else{
      			  $('#showorders').html(dot_order(order_one));
      			}
    			}
        })
    </script>


  </body>
</html>
