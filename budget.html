<!DOCTYPE html>
<html>
<head>
    <title>预算&采购 找树网</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <!-- <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> -->
    <link rel="stylesheet" href="css/basic.css" type="text/css" />
    <link rel="stylesheet" href="css/jquery.autocomplete.min.css">
    <style type="text/css">
        .zhong{
            width:1190px;
            height:600px;
            margin:0 auto;
        }
        #left{
            width:66%;
            height:auto;
            float:left;
            
        }
        #right{
            width:29%;
            height:600px;
            float:right;
        }
        .cols2{
            width:60%;
            height:40px;
            font-size: 18px;
            float:left;
            margin-bottom: 10px;
        }
        .cols1{
            width:40%;
            height:40px;
            font-size: 17px;
            float:left;
            line-height: 40px;
        }
        #r0{
            width:60px;
            height:30px;
            font-size:17px;
        }
        #r1,#r3{
            width:90px;
            height:30px;
            font-size:17px;
        }
        #r4{
            width:100px;
            height:30px;
            font-size:17px;
        }
        #r2{
            width:420px;
            height:30px;
            font-size:15px;
        }
        td{
            width:90px;
            height:28px;
            font-size:15px;
        }
        #attributeshow #summ{
            width:100%;
            border-collapse:collapse;
            background-color: #eaf5ff;
        }
        .form-control {
            border: 1px solid #e2e2e4;
            box-shadow: none;
            color: #c2c2c2;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.075) inset;
            color: #555;
            display: block;
            font-size: 14px;
            height: 23px;
            line-height: 1.42857;
            padding: 6px 12px;
            vertical-align: middle;
            width:78%;
        }
        .form_control{
            border: 1px solid #e2e2e4;
            box-shadow: none;
            color: #c2c2c2;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.075) inset;
            color: #555;
            display: block;
            font-size: 16px;
            height: 23px;
            line-height: 1.3;
            padding: 6px 8px;
            vertical-align: middle;
            margin:10px 0px;
            width:75%;
            float:left;
        }
        .form_control_alert{
            border: 1px solid #e2e2e4;
            box-shadow: none;
            color: #c2c2c2;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.075) inset;
            color: #555;
            display: block;
            font-size: 16px;
            height: 23px;
            line-height: 1.3;
            padding: 6px 8px;
            vertical-align: middle;
            margin:10px auto;
            width:78%;
        }
        .laydate-icon {
            border: 1px solid #e2e2e4;
            box-shadow: none;
            color: #c2c2c2;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.075) inset;
            color: #555;
            display: block;
            font-size: 16px;
            height: 23px;
            line-height: 1.3;
            padding: 6px 14px;
            vertical-align: middle;
            margin:5px 0px;
            width:26%;
            float:left;
        }
        .btn {
            -moz-user-select: none;
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
            font-size: 14px;
            font-weight: normal;
            line-height: 1.42857;
            margin-bottom: 0;
            margin-left: 2%;
            padding: 6px 12px;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
             background-color: #49cfff;
            border-color: #49cfff;
            color: #ffffff;
        }
        .key_btn {
            -moz-user-select: none;
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
            font-size: 16px;
            font-weight: normal;
            line-height: 1.4;
            margin-bottom: 0;
            padding: 5px 13px;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
            background-color: #49cfff;
            border-color: #49cfff;
            color: #ffffff;
            margin-left:23%;
        }
        .bn {
            -moz-user-select: none;
            border: 2px solid #ffffff;
            border-radius: 6px;
            cursor: pointer;
            display: inline-block;
            font-size: 15px;
            font-weight: normal;
            line-height: 1.42857;
            margin-bottom: 0;
            padding: 3px 6px;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
            background-color: #cccccc;
            color: #666666;
        }
        .city_bn {
            -moz-user-select: none;
            border: 2px solid #ffffff;
            border-radius: 6px;
            cursor: pointer;
            display: inline-block;
            font-size: 14px;
            font-weight: normal;
            line-height: 1.42857;
            margin-bottom: 0;
            padding: 3px 6px;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
            background-color: #ddd;
            color: #666666;
            float: left;
        }
        .alert_btn {
            -moz-user-select: none;
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
            font-size: 14px;
            font-weight: normal;
            line-height: 1.42857;
            padding: 6px 12px;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
            background-color: #49cfff;
            border-color: #49cfff;
            color: #ffffff;
            width:20%;
            margin-top:4%;
            margin-left:20%;
        }
        .history_button {
            -moz-user-select: none;
            border: 2px solid transparent;
            border-radius: 3px;
            cursor: pointer;
            display: inline-block;
            font-size: 17px;
            font-weight: normal;
            line-height: 1.3;
            padding: 1px 15px;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
            background-color: #49cfff;
            color: #666666;
            margin:1px 2px;
        }
        #trunk_diameter1,#ground_diameter1,#crown1,#plant_height1,#branch_number1,#bough_number1,#branch_length1,#bough_length1,#pot_diameter1,#branch_point_height1,#age1,#edits,#plant_height_cm1,#crown_cm1,#substrate1{
            display: none;
        }
        #sb0,#sb1,#sb2{
            display: none;
            float:left;
        }
        .sheng{
            display: none;
            float:left;
            width:auto;
        }
        .cxselect{
            width:25%;
            height:32px;
            float:left;
            margin-left: 3%;
            line-height:40px;
        }
        .hideform {
            border: 1px solid #e2e2e4;
            box-shadow: none;
            color: #c2c2c2;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.075) inset;
            color: #555;
            display: block;
            font-size: 14px;
            height: 23px;
            line-height: 1.42857;
            padding: 6px 12px;
            vertical-align: middle;
            width:20%;
            float:left;
            margin-left: 3%;
            display:none;
        }
        #span{
            width:5px;
            height:40px;
            float:left;
        }
        .clear3{
            clear:both;
            height:30px;
        }
        
        #miaodizhi{
            float:left;
        }
        #header{
            background-color: #cccccc;
            height:45px;
        }
        .tree_arrive_address_lable{
            padding-top: 15px;
            font-size: 20px;
            float: left;
            line-height: 20px;
            width:15%;
        }
        #tree_arrive_address_name{
            padding-top: 15px;
            float: left;
            width:70%;
            margin-left:2%;
        }
        #tree_arrive_address_city{
            padding-top: 5px;
            float: left;
            width:100%;
        }
        #ads{
            float: left;
            width:75%;
            margin-left: 4%;
            padding-top: 15px;
        }
        #submit_button{
            margin-top: 12px;
            float: left;
            width:100%;
        }
        #label1{
            width:40%;
            float: left;
            margin: 25px 0px 25px 10%;
            text-align: center;
            font-size: 20px;
            background:#ccc;
        }
        #label2{
            width:40%;
            float: left;
            margin: 25px 0px;
            text-align: center;
            font-size: 20px;
        }
        #history{
            float:left;
            display:none;
            width:100%;
            font-size: 16px;
        }
        .name{
           float:left;
           height:35px;
           line-height:35px;
           margin-top: 10px;
           font-size: 18px;
           width:17%;
        }
        .ordername{
            float:left;
            line-height:30px;
            font-size: 18px;
            width:58%;
        }
        .ordertime{
            float:right;
            font-size: 14px;
            width:40%;
        }
        #history_contents{
            line-height: 30px;
            margin-top:20px;
        }
        .copy,.delete{
            width:18%;
            height:28px;
            line-height: 28px;
            border:1px solid #ccc;
            border-radius: 3px;
            background:#ddd;
            margin:0px 1%;
            float:right;
            text-align: center;
        }
        .history_order_contents{
            float:left;
            width:100%;
        }
        .alertordername {
            z-index:99999;
            position:fixed;
            top:50%;
            left:50%;
            width:30%;
            height:30%;
            margin:-10% 0 0 -15%;
            border-radius:5px;
            border:solid 2px #aaa;
            background-color:#eee;
            display:none;
            box-shadow: 0 0 10px #666;
        }
        .tree_arrive_address_citys {
            float:left;
            width:100%;
            margin-top: 4px;
        }
        .area_city{
            margin-left:19%;
            font-size:17px;
            width:8%;
            float:left;
        }
        .area_city_name{
            width:67%;
            float:left;
        }
    </style>
</head>
<body>
    <div class="alertordername">
        <div style="text-align:center;margin:6% 0px;"><h1>输入您的订单名称</h1></div>
        <input type="text" id="order_name" class="form_control_alert">
        <button type="button" id="order_name_button" class="alert_btn">提交</button>
        <button type="button" id="order_name_button_reset" class="alert_btn">取消</button>
    </div>
    <div class="shortcut">
        <div class="wrap">
            <div class="fl">
                <span id="welcome">亲,欢迎来找树</span>  
                <a href="javascript:login()" id="login">请登录</a>
                <a href="javascript:logout()" id="logout">退出</a>
            </div>
            <span class="phone">☎19933553935</span>
            <a class="qq" href="http://wpa.qq.com/msgrd?v=3&amp;uin=31905376&amp;site=qq&amp;menu=yes" 
                title="在线客服 QQ 31905376">在线客服</a>
        </div>
    </div>
    <div class="nav">
        <div class="wrap">
            <a href=".">首页</a>
            <a href="mytree.html">我的苗店</a>
            <a href="findtree.html">我的找树车</a>
            <a href="findtree.html" class="selected">预算</a>
            <a href="open.html" class="fr">开放平台</a>
            <a href="http://mp.weixin.qq.com/mp/homepage?__biz=MjM5MTQwMzA1OQ==&hid=1" class="fr">新闻中心</a>
            <a href="about.html" class="fr">关于我们</a>
            <a href="http://mp.weixin.qq.com/s?__biz=MjM5MTQwMzA1OQ==&mid=203858056&idx=1&sn=57d46cb9c073b21d7311c5e76248dcf8&scene=1&key=2e5b2e802b7041cf27bdb357cf32162b9f411c3a4237247b6e0ce9dde679aa69ed88ef1bd6246e172495e1341f759811&ascene=1&uin=MTMwMTQ4NTIwNA%3D%3D&devicetype=webwx&version=70000001&pass_ticket=5SzduPctzoCWysrY7mdIEXpNi3sU0kpjrPWn8YXW0UIb9Wyuqd8%2BXQ%2BqD9lVYNak" class="fr">手机版</a>
            <a href="http://mp.weixin.qq.com/s?__biz=MjM5MTQwMzA1OQ==&mid=203617198&idx=1&sn=1a78a207b6ca1bdf0accac78745f548a&scene=1&key=2e5b2e802b7041cf3ef8f671071823b9fb4b20da6739ef5fb7a0f92dccf51b7b53ceb3517fe3f26a7238c80e3c8186f7&ascene=1&uin=MTMwMTQ4NTIwNA%3D%3D&devicetype=webwx&version=70000001&pass_ticket=5SzduPctzoCWysrY7mdIEXpNi3sU0kpjrPWn8YXW0UIb9Wyuqd8%2BXQ%2BqD9lVYNak" class="fr">帮助</a>
        </div>
    </div>
    <div class="zhong">
            <div id="left">
                <div id="fatherresetinput" style="float:left;">
                    <table id="attributeshow" style="border-collapse:collapse;margin-top:15px;" border="1">
                    </table>
                </div>
                <label class="tree_arrive_address_lable">用苗地点:</label>
                <div id="tree_arrive_address_name">
                    <select class="province form-control cxselect"></select>
                    <input type="text" name="province" class="hideform">
                    <select class="city form-control cxselect"></select>
                    <input type="text" name="city" class="hideform">
                    <select class="area form-control cxselect"></select>
                    <input type="text" name="area" class="hideform">
                </div>
                <div id="tree_arrive_aaddress">
                    <label class="tree_arrive_address_lable">选定苗源地:</label>
                    <div id="ads"></div>
                </div>
                <div id="tree_arrive_address_city">
                </div>
                <div id="submit_button">
                    <button type="button" id="join_order" class="btn" style="margin-left:0px;">存入我的清单</button>
                    <button type="button" id="deal" class="btn">预算用导出</button>
                    <button type="button" id="myorder" class="btn">采购用导出</button>
                </div>
            </div>

            <div id="right">
                <div id="fatherresetinput">
                <form>
                    <div>
                        <div id="label1">录入清单</div>
                        <div id="label2">历史清单</div>
                    </div>
                    <div id="attributein">
                        <div>
                            <div class="cols1">苗木名称:</div>
                            <div class="cols2"><input type="text" id="name" class="form-control"><input type="hidden" id="name-id" class="form-control"></div>
                        </div>
                        <div id="trunk_diameter1">
                            <div class="cols1">胸 &nbsp;径(公分):</div>
                            <div class="cols2"><input type="text" id="trunk_diameter" placeholder="10或10-20" onkeyup="value=value.replace(/[^\d\.\-\－\。]/g,'')" onpaste="return false"  class="form-control"></div>
                        </div>
                        <div id="ground_diameter1">
                            <div class="cols1">地 &nbsp;径(公分):</div>
                            <div class="cols2"><input type="text" id="ground_diameter" placeholder="10或10-20" onkeyup="value=value.replace(/[^\d\.\-\－\。]/g,'')" onpaste="return false" class="form-control"></div>
                        </div>
                        <div id="pot_diameter1">
                            <div class="cols1">盆 &nbsp;径(公分):</div>
                            <div class="cols2"><input type="text" id="pot_diameter" placeholder="10或10-20" onkeyup="value=value.replace(/[^\d\.\-\－\。]/g,'')" onpaste="return false" class="form-control"></div>
                        </div>
                        <div id="plant_height1">
                            <div class="cols1">株 &nbsp;高(米):</div>
                            <div class="cols2"><input type="text" id="plant_height" placeholder="10或10-20" onkeyup="value=value.replace(/[^\d\.\-\－\。]/g,'')" onpaste="return false" class="form-control"></div>
                        </div>
                        <div id="plant_height_cm1">
                            <div class="cols1">株 &nbsp;高(公分):</div>
                            <div class="cols2"><input type="text" id="plant_height_cm" placeholder="10或10-20" onkeyup="value=value.replace(/[^\d\.\-\－\。]/g,'')" onpaste="return false" class="form-control"></div>
                        </div>
                        <div id="crown1">
                            <div class="cols1">冠 &nbsp;幅(米):</div>
                            <div class="cols2"><input type="text" id="crown" placeholder="10或10-20" onkeyup="value=value.replace(/[^\d\.\-\－\。]/g,'')" onpaste="return false" class="form-control"></div>
                        </div>
                        <div id="crown_cm1">
                            <div class="cols1">冠 &nbsp;幅(公分):</div>
                            <div class="cols2"><input type="text" id="crown_cm" placeholder="10或10-20" onkeyup="value=value.replace(/[^\d\.\-\－\。]/g,'')" onpaste="return false" class="form-control"></div>
                        </div>
                        <div id="branch_number1">
                            <div class="cols1">分&nbsp;枝&nbsp;数(个):</div>
                            <div class="cols2"><input type="text" id="branch_number" placeholder="10" onkeyup="value=value.replace(/[^\d\.\-\－\。]/g,'')" onpaste="return false" class="form-control"></div>
                        </div>
                        <div id="bough_number1">
                            <div class="cols1">主&nbsp;枝&nbsp;数(个):</div>
                            <div class="cols2"><input type="text" id="bough_number" placeholder="10" onkeyup="value=value.replace(/[^\d\.\-\－\。]/g,'')" onpaste="return false" class="form-control"></div>
                        </div>
                        <div id="branch_length1">
                            <div class="cols1">条 &nbsp;长(米):</div>
                            <div class="cols2"><input type="text" id="branch_length" placeholder="10或10-20" onkeyup="value=value.replace(/[^\d\.\-\－\。]/g,'')" onpaste="return false" class="form-control"></div>
                        </div>
                        <div id="bough_length1">
                            <div class="cols1">主蔓(枝)长(米):</div>
                            <div class="cols2"><input type="text" id="bough_length" placeholder="10或10-20" onkeyup="value=value.replace(/[^\d\.\-\－\。]/g,'')" onpaste="return false" class="form-control"></div>
                        </div>
                        <div id="branch_point_height1">
                            <div class="cols1">分枝点高(米):</div>
                            <div class="cols2"><input type="text" id="branch_point_height" placeholder="10或10-20" onkeyup="value=value.replace(/[^\d\.\-\－\。]/g,'')" onpaste="return false" class="form-control"></div>
                        </div>
                        <div id="age1">
                            <div class="cols1">苗 &nbsp;龄(年):</div>
                            <div class="cols2"><input type="text" id="age" placeholder="10" onkeyup="value=value.replace(/[^\d\.\-\－\。]/g,'')" onpaste="return false" class="form-control"></div>
                        </div>
                        <div id="substrate1">
                            <div class="cols1">基 &nbsp;质:</div>
                            <div class="cols2"><input type="text" id="substrate" class="form-control"></div>
                        </div>
                        <div>
                            <div class="cols1">数 &nbsp;量:</div>
                            <div class="cols2"><input type="text" onkeyup='this.value=this.value.replace(/\D/gi,"")' id="count" class="form-control"></div>
                        </div>
                        <div>
                            <div class="cols1"></div>
                            <div class="cols2"><button type="button" id="add" class="btn">添加</button><span>&nbsp;</span><button type="button" id="reset" class="btn">清空</button><span>&nbsp;</span></div>
                        </div>
                    </div>
                    <div id="history">
                        <div class="name">名 称 :</div><input type="text" id="key_name" class="form_control">
                        <div class="name">地 址 :</div><input type="text" id="key_area" class="form_control">
                        <div class="name">时 间 :</div><input placeholder="输入日期" class="laydate-icon" id="demo" value=""><div style="float:left;margin-top:12px;width:8%;text-align:center">至</div><input placeholder="输入日期" id="key_time2" class="laydate-icon" onclick="laydate()">
                        <button type="button" id="key_search" class="key_btn">查询</button>
                        <button type="button" id="key_reset" class="key_btn">清空</button>
                        <div id="history_contents">
                        </div>
                    </div>
                </form> 
                <div class="clear3"></div>
                </div>
            </div>
    </div>
    <div class="clear3"></div>
    <div class="footer wrap">
        <img src="/img/wx.jpg" alt="微信找树">
        <p>
            <a href="about.html">关于我们</a>｜
            <a href="about.html">领导寄语</a>｜
            <a href="about.html">联系我们</a>｜
            <a href="about.html">合作伙伴</a>
        </p>
        <p>Copyright © 2014-2016  找树网 & 北京汉林国际园林工程有限公司 版权所有 京ICP证1403号</p>
        <p>
            <a href="http://www.itrust.org.cn/" target="_blank"><img src="/img/f1.jpg"></a>
            <a href="http://www.bnia.cn/" target="_blank"><img src="/img/f2.jpg"></a>
            <a href="http://net.china.com.cn/" target="_blank"><img src="/img/f3.jpg"></a>
            <a href="http://www.bjjubao.org/" target="_blank"><img src="/img/f4.jpg"></a>
            <a href="http://www.bj.cyberpolice.cn/" target="_blank"><img src="/img/f5.jpg"></a>
        </p>
    </div>
<script src="js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="js/jquery.blockui.js"></script>
<script type="text/javascript" src="js/basic.js?t=20161211"></script>
<!--  省市县三级联动js -->
<script src="js/jquery.cxselect.min.js"></script>
<!-- input填写联想js -->
<script src="js/jquery.autocomplete.min.js"></script>
<!-- 时间js是js下的laydate文件夹 -->
<script src="js/laydate/laydate.js"></script>
<script type="text/javascript">
      
    // var user = {userid:29908};
    var rows;
    var rand;
    var n;
    var deleten;
    var data = [];
    var dataid;
    var j = 0;
    var dictionary_keys = [];
    var dictionary = [];
    var addressprice = [];
    var unit;
    var typename;
    var type;
    var county = [];
    var markj;
    var addresspricess;
    var datas;
    var detailed_address;
    var provinces = [];
    var buttomnum;
    var buttonumber = 1;
    var order_detail = [];
    var ordername;
    var button_ordernumber = 0;
    var cities = '';
    var fatherprivious = '';
    var pricescity = [];
    var sohard = [];
    var finalkey;
    var finalprice;
    var sheng = ['安徽','北京','重庆','福建','甘肃','广东','广西','贵州','海南','河北','河南','黑龙江','湖北','湖南','山东','吉林','江苏','江西','辽宁','内蒙古','宁夏','青海','山西','陕西','上海','四川','天津','新疆','云南','浙江'];
    var showsheng = sheng;
    
    
    function loadaddress(){
        var html = '';
        for (var i = 0; i < sheng.length; i++) {
            html += '<label class="bn sheng" id="sheng'+i+'"><input type="checkbox" value="'+sheng[i]+'">'+sheng[i]+'</label>';
        }
        $('#ads').html(html);
    };

    function loadHistoryData (){
        html = '<caption><h1>苗木清单</h1></caption><tr id="header"><th id="r0">序号</th><th id="r4">编号</th><th id="r1">名称</th><th id="r2">规格(选中试试双击)</th><th id="r1">数量</th></tr>';
            $.getJSON('/com/order_temp_search.php',{uid:user.userid},function(json){
                if(json){
                    var counts = 0;
                    for (var i = 0; i < json.length; i++) {

                        data[i] = json[i];
                        j = 1+i;
                        var attr = attributes_show(json[i]);
                        attribute_shift(data[i]);
                        html += '<tr>';
                        html += '<th>'+j+'</th>';
                        html += '<td id="edit">'+json[i].id+'</td>';
                        html += '<td>'+json[i].name+'</td>';
                        html += '<td>'+attr+'</td>';
                        html += '<td>'+json[i].count+'</td>';
                        counts += json[i].count;
                        html += '</tr>';
                    }
                    selectarea(data);
                    $('#attributeshow').html(html);
                    $("#attributeshow").append('<tr><td></td><td></td><td></td><td></td><td></td></tr>');
                    $('#attributeshow tr').filter(':eq('+(1+i)+')').html('<th id="r2" colspan=4>合计:</th><td id="r1">'+counts+'</td>');
                }
            });
        $('#attributeshow').html(html);
    }

    function selectarea(condition){
        $.getJSON('/com/search_price_batch.php',{data:JSON.stringify(condition)},function(json){
            for (var i = 0; i < json.length; i++) {
                provinces[i] = [];
                addressprice[i] = {};
                for (var y = 0; y < condition.length; y++) {
                    if(condition[y].id == json[i].id){
                        addressprice[i].id = json[i].id;
                        if(json[i].price){
                            var p = 0;
                            addressprice[i].price = [];
                            for (var z = 0; z < json[i].price.length; z++) {
                                // if(json[i].price[z].total >= condition[y].count){
                                    addressprice[i].price[p] = json[i].price[z];
                                    provinces[i][p] = json[i].price[z].province;
                                    p++;
                                // }
                            }
                        }else{
                            addressprice[i].price = [];
                            provinces[i] = '';
                        }
                    }
                }
            }
            var haves = [''];
            for (var x = 0; x < provinces.length; x++) {
                for (var z = 0; z < provinces[x].length; z++) {
                    var y = 0;
                    for (var i = 0; i < haves.length; i++) {
                        if(haves[i] != provinces[x][z]){
                            ++y;
                        }
                        if(y == haves.length){
                            haves[haves.length] = provinces[x][z];
                        }
                    }
                }
            }   
            // 显示交集省份
            $('.sheng').hide();
            for (var i = 0; i < haves.length; i++) {
                $('#ads input[type="checkbox"][value="'+haves[i]+'"]').parent().show();
            } 
        });
    }
    
    function attribute_shift(shift){
        if(shift.trunk_diameter){
            shift.trunk_diameter = shift.trunk_diameter.split(',');
        }
        if(shift.ground_diameter){
            shift.ground_diameter = shift.ground_diameter.split(',');
        }
        if(shift.plant_height){
            shift.plant_height = shift.plant_height.split(',');
        }
        if(shift.crown){
            shift.crown = shift.crown.split(',');
        }
        if(shift.branch_number){
            shift.branch_number = shift.branch_number.split(',');
        }
        if(shift.bough_number){
            shift.bough_number = shift.bough_number.split(',');
        }
        if(shift.age){
            shift.age = shift.age.split(',');
        }
        if(shift.branch_length){
            shift.branch_length = shift.branch_length.split(',');
        }
        if(shift.bough_length){
            shift.bough_length = shift.bough_length.split(',');
        }
        if(shift.branch_point_height){
            shift.branch_point_height = shift.branch_point_height.split(',');
        }
        if(shift.pot_diameter){
            shift.pot_diameter = shift.pot_diameter.split(',');
        }
        if(shift.crown_cm){
            shift.crown_cm = shift.crown_cm.split(',');
        }
        if(shift.plant_height_cm){
            shift.plant_height_cm = shift.plant_height_cm.split(',');
        }
    }

    function attributes_show(data_attribute){
        var attr = '';   

        if(data_attribute.trunk_diameter){
            var value = data_attribute.trunk_diameter.replace(',','-');
            attr += ' 胸径' + value + '公分';
        }
        if(data_attribute.pot_diameter){
            var value = data_attribute.pot_diameter.replace(',','-');
            attr += ' 盆径'+value+'公分';
        }
        if(data_attribute.ground_diameter){
            var value = data_attribute.ground_diameter.replace(',','-');
            attr += ' 地径'+value+'公分';
        }
        if(data_attribute.plant_height){
            var value = data_attribute.plant_height.replace(',','-');
            attr += ' 株高'+value+'米';
        }
        if(data_attribute.plant_height_cm){
            var value = data_attribute.plant_height_cm.replace(',','-');
            attr += ' 株高'+value+'公分';
        }
        if(data_attribute.crown){
            var value = data_attribute.crown.replace(',','-');
            attr += ' 冠幅'+value+'米';
        }
        if(data_attribute.crown_cm){
            var value = data_attribute.crown_cm.replace(',','-');
            attr += ' 冠幅'+value+'公分';
        }
        if(data_attribute.branch_number){
            var value = data_attribute.branch_number.replace(',','-');
            attr += ' 分枝数'+value+'个';
        }
        if(data_attribute.bough_number){
            var value = data_attribute.bough_number.replace(',','-');
            attr += ' 主枝数'+value+'个';
        }
        if(data_attribute.age){
            var value = data_attribute.age.replace(',','-');
            attr += ' 苗龄'+value+'年';
        }
        if(data_attribute.branch_length){
            var value = data_attribute.branch_length.replace(',','-');
            attr += ' 条长'+value+'米';
        }
        if(data_attribute.bough_length){
            var value = data_attribute.bough_length.replace(',','-');
            attr += ' 主蔓(枝)长'+value+'米';
        }
        if(data_attribute.branch_point_height){
            var value = data_attribute.branch_point_height.replace(',','-');
            attr += ' 分枝点高'+value+'米';
        }
        if(data_attribute.substrate){
            var value = data_attribute.substrate;
            attr += ' 基质'+value;
        }
        return attr;
    }

    function toadd(){
        var caozuo = $('#add').html();
        var content = {};
        for (var i = 0; i < 15; i++) {
            if($(":input:text:eq(" + i + ")").is(':hidden')){
                $(":input:text:eq(" + i + ")").val(''); 
            }
        }
        if($.trim($('#name').val())!='') content.name = $('#name').val();
        if($.trim($('#trunk_diameter').val())!='') content.trunk_diameter = sort($('#trunk_diameter').val());
        if($.trim($('#plant_height').val())!='') content.plant_height = sort($('#plant_height').val());
        if($.trim($('#crown').val())!='') content.crown = sort($('#crown').val());
        if($.trim($('#branch_point_height').val())!='') content.branch_point_height = sort($('#branch_point_height').val());
        if($.trim($('#branch_number').val())!='') content.branch_number = sort($('#branch_number').val());
        if($.trim($('#ground_diameter').val())!='') content.ground_diameter = sort($('#ground_diameter').val());
        if($.trim($('#bough_number').val())!='') content.bough_number = sort($('#bough_number').val());
        if($.trim($('#plant_height_cm').val())!='') content.plant_height_cm = sort($('#plant_height_cm').val());
        if($.trim($('#crown_cm').val())!='') content.crown_cm = sort($('#crown_cm').val());
        if($.trim($('#substrate').val())!='') content.substrate = $('#substrate').val();
        if($.trim($('#age').val())!='') content.age = sort($('#age').val());
        if($.trim($('#branch_length').val())!='') content.branch_length = sort($('#branch_length').val());
        if($.trim($('#pot_diameter').val())!='') content.pot_diameter = sort($('#pot_diameter').val());
        if($.trim($('#bough_length').val())!='') content.bough_length = sort($('#bough_length').val());
        if($.trim($('#count').val())!='') content.count = $('#count').val();
        if(isEmptyObject(content) && (content.count != null) && (content.name != null)){
            if(unit || typename || type){
                content.unit = unit;
                content.typename = typename;
                content.type = type;
            }else{
                content.unit = '株';
                content.typename = '其他';
                content.type = '11';
            }
            $('#attributein input').val('');
            hideattribute();
            var attr = guige(content);
                if(caozuo == '添加'){
                    randomget();
                    content.id = rand;
                    rand = '';
                    shaixuandiqu(content);
                    data[j] = content;
                    j++;
                    $.get('/com/order_temp_add.php',{uid:user.userid, data:JSON.stringify(content)},function(){
                        
                    });
                }else{
                    
                    content.id =  dataid;
                    shaixuandiqu(content);
                        data[n] = content;
                        $('#add').html('添加');
                        $('#reset').html('清空');
                    $.get('/com/order_temp_update.php',{uid:user.userid, data:JSON.stringify(content)},function(){

                    });
                }
                $('#attributein input:text:first').focus();
        }else{
            alert('名称或数量未填写');
            $('#attributein #count').focus();
        }
    }

    function randomget(){
        rand = parseInt(Math.random()*1000000000);
        if(rand < 100000000 || rand == 1000000000){
            randomget();
        }else{
            rand = '050'+rand;
            return rand;
        }
    }

    function guige(content){
        var attr = '';
        if(parseFloat(content.trunk_diameter) > 0){
            attr += ' 胸径:'+mark(content.trunk_diameter)+'公分';
        }
        if(parseFloat(content.ground_diameter) > 0){
            attr += ' 地径:'+mark(content.ground_diameter)+'公分';
        }
        if(parseFloat(content.plant_height) > 0){
            attr += ' 株高:'+mark(content.plant_height)+'米';
        }
        if(parseFloat(content.plant_height_cm) > 0){
            attr += ' 株高:'+mark(content.plant_height_cm)+'公分';
        }
        if(parseFloat(content.crown) > 0){
            attr += ' 冠幅:'+mark(content.crown)+'米';
        }
        if(parseFloat(content.crown_cm) > 0){
            attr += ' 冠幅:'+mark(content.crown_cm)+'公分';
        }
        if(parseFloat(content.branch_number) > 0){
            attr += ' 分枝数:'+mark(content.branch_number)+'个';
        }
        if(parseFloat(content.bough_number) > 0){
            attr += ' 主枝数:'+mark(content.bough_number)+'个';
        }
        if(parseFloat(content.age) > 0){
            attr += ' 苗龄:'+mark(content.age)+'年';
        }
        if(parseFloat(content.branch_length) > 0){
            attr += ' 条长:'+mark(content.branch_length)+'米';
        }
        if(parseFloat(content.bough_length) > 0){
            attr += ' 主蔓(枝)长:'+mark(content.bough_length)+'米';
        }
        if(parseFloat(content.branch_point_height) > 0){
            attr += ' 分枝点高:'+mark(content.branch_point_height)+'米';
        }
        if(parseFloat(content.pot_diameter) > 0){
            attr += ' 盆径:'+mark(content.pot_diameter)+'公分';
        }
        if(content.substrate != undefined){
            attr += ' 基质:'+content.substrate;
        }
        return attr;
    }

    function mark(att){
        if(att){
            if(att[1]){
                return att[0]+'-'+att[1];
            }else if(parseFloat(att[0]) > 0){
                return att[0];
            }
        }
    }

    // 筛选地区
    function shaixuandiqu(tiaojian){
        $.getJSON('/com/search_price.php',{data:JSON.stringify(tiaojian)},function(json){
            var info = json.price;
                // 将省份信息给addressprice数组

                if(n > -1){
                    addressprice[n] = json;
                    n = -1;
                }else{
                    addressprice[j-1] = json;
                }
            if(json.price){
                var infoprovinces = [];
                // 获取省份信息给provinces数组中
                var m = 0;
                for (var i = 0; i < info.length; i++) {
                    m += 1;
                    var count = info[i].count;
                    var province = info[i].province;
                    var total = info[i].total;
                    // if(total >= tiaojian.count){
                        infoprovinces[i] = province;
                    // }
                }
                provinces[j-1] = infoprovinces;
            }
            var haves = [''];
            for (var x = 0; x < provinces.length; x++) {
                if(provinces[x] != undefined){
                    for (var z = 0; z < provinces[x].length; z++) {
                        var y = 0;
                        for (var i = 0; i < haves.length; i++) {
                            if(haves[i] != provinces[x][z]){
                                ++y;
                            }
                            if(y == haves.length){
                                haves[haves.length] = provinces[x][z];
                            }
                        }
                    }
                }

            }   
            $('.sheng').hide();
            $('.tree_arrive_address_citys').hide();
            $('input[type="checkbox"]').prop("checked",false);
            
            cities = '';
            fatherprivious = '';
            pricescity = [];
            sohard = [];
            for (var i = 0; i < haves.length; i++) {
                $('#ads input[type="checkbox"][value="'+haves[i]+'"]').parent().show();
            }   
            showprice();
        });
    }
    // 分为数组
    function sort(req){

        return req.replace('－','-').replace('。','.').split('-');
    }

    function reset(){
        var rightbtnname = $('#reset').html();
        if(rightbtnname == '清空'){
            $('#attributein input').val('');
        }else{
            var deleteid = data[n]['id'];
            data[n] = '';
            addressprice[n] = '';
            provinces[n] = '';
            $('input[type="checkbox"]').prop("checked",false);
            $('#tree_arrive_address_city').html('');
            cities = '';
            fatherprivious = '';
            pricescity = [];
            sohard = [];
            showprice();
            n = -1;
            $('#attributein input').val('');
            hideattribute();
            $('#add').html('添加');
            $('#reset').html('清空');
            $('#attributeshow').css('background-color','#ffffff');
            $('#header').css('background-color','#cccccc');
            // 删除数据
            $.get('/com/order_temp_deletepc.php',{userid:user.userid, id:deleteid},function(){
                });
        }
    }
     
    // 按名称找规格
    function zhaoname(){
        // 发送ajax查询名称所对应的属性
        var name = $('#name').val();
        var json;
        for (var i = 0; i < dictionary.length; i++) {
            if(dictionary[i].name == name){
                json = dictionary[i];
            }
        }   
        var dictionary_attributes = {5:'trunk_diameter',6:'ground_diameter',7:'pot_diameter',8:'age',9:'crown',10:'plant_height',11:'branch_length',12:'bough_length',13:'branch_point_height',14:'branch_number',15:"bough_number",17:'plant_height_cm',18:'crown_cm',19:'substrate'};
        for (var i = 5; i < 20; i++) {
          $('#'+dictionary_attributes[i]+'1').hide();
        }

        if(!json){
            $('#name-id').val(name);
            $('#trunk_diameter1').show();
            $('#crown1').show();
            $('#plant_height1').show();
        }else{
            var attribute = json.attribute;
            unit = json.unit;
            typename = json.typename;
            type = json.type;
            var attributes = attribute.split(',');
            for (var z = 0; z < attributes.length; z++) {
                if(dictionary_attributes[ attributes[z] ]){
                    $('#'+dictionary_attributes[ attributes[z] ]+'1').show();
                }
            }
        }
    };

    // 隐藏规格
    function hideattribute(){
        var dictionary_attributes = {5:'trunk_diameter',6:'ground_diameter',7:'pot_diameter',8:'crown',9:'plant_height',10:'branch_length',11:'bough_length',12:'branch_point_height',13:'branch_number',14:'bough_number',15:"age",17:'plant_height_cm',18:'crown_cm',19:'substrate'};
        for (var i = 5; i < 20; i++) {
            $('#'+dictionary_attributes[i]+'1').hide();
        }
    }

    // 简拼搜索
    $( function() {
        $.getJSON('/com/dictionary_attribute_search.php',function(json){
            if (json) {
                dictionary = json;
                $( "#name" ).autocomplete({
                  minLength: 2,
                  source: dictionary,
                  // 寻找事件
                  search: function( item ) {
                    return item.jianpin+item.name;
                    
                  },
                  // 列表显示内容
                  label: function( item ) {
                    
                    return item.name;
                  },
                  // 选定事件
                  select: function( text ) {
                    buttomnum = -1;
                    $( "#name-id" ).val( text );
                    zhaoname();
                  }
                    
                });
            }
        }); 
    });
    
    function isEmptyObject(e) {  
        var t;  
        for (t in e)  
            return true;  
        return false;  
    }  

    // 修改
    $("#attributeshow").on("click",'tr', function() {
        var sh = $(this).find('#r2').html();
        var st = $(this).find('#r0').html();
        if(sh == "合计:" || st == "序号"){
            return false;
        }else{
                var editnum = $(this).find('#edit').html();
                $(this).css('background','#cccccc');
                $(this).siblings().css('background','#ffffff');
                $('#header').css('background-color','#cccccc');
                dataid = $(this).find('#edit').html();
                rows = $(this).find('#edit').prev().html();
                for (var i = 0; i < data.length; i++) {
                    if(data[i].id == dataid){
                        n = i;
                    }
                }
                var content = data[n];
                var dictionary_attributes = {5:'trunk_diameter',6:'ground_diameter',7:'pot_diameter',8:'crown',9:'plant_height',10:'branch_length',11:'bough_length',12:'branch_point_height',13:'branch_number',14:'bough_number',15:"age",17:'plant_height_cm',18:'crown_cm',19:'substrate'};
                for (var i = 5; i < 20; i++) {
                    if(content[dictionary_attributes[i]]){
                        $('#'+dictionary_attributes[i]+'1').css('display','black');
                        $('#'+dictionary_attributes[i]).val(content[dictionary_attributes[i]]);
                    }
                }
                $('#add').html('修改');
                $('#reset').html('删除');
                // 隐藏规格
                hideattribute();
                var name = $('#name').val(content.name);
                zhaoname();
                $('#count').val(content.count);
                $('#trunk_diameter').val(join(content.trunk_diameter));
                $('#plant_height').val(join(content.plant_height));
                $('#crown').val(join(content.crown));
                $('#branch_point_height').val(join(content.branch_point_height));
                $('#branch_number').val(join(content.branch_number));
                $('#ground_diameter').val(join(content.ground_diameter));
                $('#bough_number').val(join(content.bough_number));
                $('#age').val(join(age));
                $('#branch_length').val(join(content.branch_length));
                $('#pot_diameter').val(join(content.pot_diameter));
                $('#plant_height_cm').val(join(content.plant_height_cm));
                $('#crown_cm').val(join(content.crown_cm));
                $('#substrate').val(content.substrate);
                $('#bough_length').val(join(content.bough_length));
                buttomnum = n;
        }
    });         
    
    $("#attributeshow").on("dblclick",'tr', function() {
        var sh = $(this).find('#r2').html();
        var st = $(this).find('#r0').html();
        if(sh == "合计:" || st == "序号"){
            return false;
        }else{
            var editnum = $(this).find('#edit').html();

            for (var i = 0; i < data.length; i++) {
                if(data[i].id == dataid){
                    n = i;
                }
            }

            var content = data[n];
            var indexdata = '"exact":1,"key":"'+content.name+'"';
            if(content.trunk_diameter){
                if(content.trunk_diameter[1]){
                    indexdata += ',"dbh":"'+content.trunk_diameter[0]+'-'+content.trunk_diameter[1]+'"';
                }else if(content.trunk_diameter[0]){
                    indexdata += ',"dbh":"'+content.trunk_diameter[0]+'"';
                }
            }else if(content.ground_diameter){
                if(content.ground_diameter[1]){
                    indexdata += ',"dbh":"'+content.ground_diameter[0]+'-'+content.ground_diameter[1]+'"';
                }else if(content.ground_diameter[0]){
                    indexdata += ',"dbh":"'+content.ground_diameter[0]+'"';
                }
            }else if(content.pot_diameter){
                if(content.pot_diameter[1]){
                    indexdata += ',"dbh":"'+content.pot_diameter[0]+'-'+content.pot_diameter[1]+'"';
                }else if(content.pot_diameter[0]){
                    indexdata += ',"dbh":"'+content.pot_diameter[0]+'"';
                }
            }
            if(content.plant_height){
                if(content.plant_height[1]){
                    indexdata += ',"height":"'+content.plant_height[0]+'-'+content.plant_height[1]+'"';
                }else if(content.plant_height[0]){
                    indexdata += ',"height":"'+content.plant_height[0]+'"';
                }
            }else if(content.branch_length){
                if(content.branch_length[1]){
                    indexdata += ',"height":"'+content.branch_length[0]+'-'+content.branch_length[1]+'"';
                }else if(content.branch_length[0]){
                    indexdata += ',"height":"'+content.branch_length[0]+'"';
                }
            }else if(content.bough_length){
                if(content.bough_length[1]){
                    indexdata += ',"height":"'+content.bough_length[0]+'-'+content.bough_length[1]+'"';
                }else if(content.bough_length[0]){
                    indexdata += ',"height":"'+content.bough_length[0]+'"';
                }
            }else if(content.plant_height_cm){
                if(content.plant_height_cm[1]){
                    indexdata += ',"height":"'+(content.plant_height_cm[0])/100+'-'+(content.plant_height_cm[1])/100+'"';
                }else if(content.plant_height_cm[0]){
                    indexdata += ',"height":"'+(content.plant_height_cm[0])/100+'"';
                }
            }
            if(content.crown){
                if(content.crown[1]){
                    indexdata += ',"crownwidth":"'+content.crown[0]+'-'+content.crown[1]+'"';
                }else if(content.crown[0]){
                    indexdata += ',"crownwidth":"'+content.crown[0]+'"';
                }
            }
            if(content.crown_cm){
                if(content.crown_cm[1]){
                    indexdata += ',"crownwidth":"'+(content.crown_cm[0])/100+'-'+(content.crown_cm[1])/100+'"';
                }else if(content.crown_cm[0]){
                    indexdata += ',"crownwidth":"'+(content.crown_cm[0])/100+'"';
                }
            }
            if(content.branch_point_height){
                if(content.branch_point_height[1]){
                    indexdata += ',"branch_point_height":"'+content.branch_point_height[0]+'-'+content.branch_point_height[1]+'"';
                }else if(content.branch_point_height[0]){
                    indexdata += ',"branch_point_height":"'+content.branch_point_height[0]+'"';
                }
            }
            if(content.branch_number){
                if(content.plant_height[1]){
                    indexdata += ',"branch_bough_number":"'+content.branch_number[0]+'-'+content.branch_number[1]+'"';
                }else if(content.branch_number[0]){
                    indexdata += ',"branch_bough_number":"'+content.branch_number[0]+'"';
                }
            }
            if(content.bough_number){
                if(content.bough_number[1]){
                    indexdata += ',"branch_bough_number":"'+content.bough_number[0]+'-'+content.bough_number[1]+'"';
                }else if(content.bough_number[0]){
                    indexdata += ',"branch_bough_number":"'+content.bough_number[0]+'"';
                }
            }
            if(content.substrate){
                if(content.substrate){
                    indexdata += ',"substrate":"'+content.substrate+'"';
                }
            }
            window.open('http://cnzhaoshu.com/index.html?where={'+indexdata+'}'); 
            
        }
    });

    // 数组还原
    function join(req){
        if(req){
            if(req[1]){
                return req[0]+'-'+req[1];
            }else{
                return req[0];
            }
        }
    }


    function showprice(){
        finalkey = [];
        finalprice = [];
        var allprice = [];
        var allareaprice = [];
        var shengfen = '';
        $('#ads input:checkbox:checked').each(function() {
            shengfen += $(this).val()+',';
        });
        shengfen = shengfen.substring(0,shengfen.length-1);
        for (var i = 0; i < allprice.length; i++) {
            allprice[i] = 0;
        }
        for (var q = 0; q < cities.length; q++) {
            allareaprice[q] = 0;
        }
        shengfen = shengfen.split(',');
        console.log(shengfen);
        var haves = [''];

        for (var x = 0; x < provinces.length; x++) {
            if(provinces[x] != undefined){
                for (var z = 0; z < provinces[x].length; z++) {
                    var y = 0;
                    for (var i = 0; i < haves.length; i++) {
                        if(haves[i] != provinces[x][z]){
                            ++y;
                        }
                        if(y == haves.length){
                            haves[haves.length] = provinces[x][z];
                        }
                    }
                }
            }
        } 
        var havs = [];
        for (var i = 0; i < sheng.length; i++) {
              for (var x = 0; x < haves.length; x++) {
                  if(sheng[i] == haves[x]){
                    havs[havs.length] = haves[x];
                  }
              }
          }
        haves = [];
        haves = havs;
        $('.sheng').hide();
        var shengfens = [];
        console.log(haves);
        for (var i = 0; i < haves.length; i++) {
            $('#ads input[type="checkbox"][value="'+haves[i]+'"]').parent().show();
            for (var x = 0; x < shengfen.length; x++) {
                if(shengfen[x] == haves[i]){
                    shengfens[shengfens.length] = shengfen[x];
                }
            }
        }          
        shengfen = shengfens;
        $("#ads input[type='checkbox']").prop("checked",false);
        for (var i = 0; i < shengfen.length; i++) {
            $('#ads input[value=\''+shengfen[i]+'\']').prop("checked","checked");
        }
        var htmld = '<caption><h1>苗木清单</h1></caption><tr id="header"><th id="r0">序号</th><th id="r1">编号</th><th id="r0">名称</th><th id="r2">规格(选中试试双击)</th><th id="r0">数量</th>';
        for (var i = 0; i < shengfen.length; i++) {
            if(shengfen[i]){
                var tt = 0;
                if(fatherprivious){
                    for (var t = 0; t < fatherprivious.length; t++) {
                        if(fatherprivious[t] == shengfen[i]){
                            tt = 1;
                        }
                    }
                }
                if(tt == 0){
                    htmld += '<th id="r0">'+shengfen[i]+'</th>';
                    finalkey[finalkey.length] = shengfen[i];
                }
            }
        }
        for (var i = 0; i < cities.length; i++) {
            if(cities[i]){
                htmld += '<th id="r0">'+cities[i]+'</th>';
                finalkey[finalkey.length] = cities[i];
            }
        }
            htmld += '</tr>';

        var countes = 0;
        for (var z = 0; z < shengfen.length; z++) {
            allprice[z] = 0;
        }
        
        var y = 0;
        for (var i = 0; i < data.length; i++) {
            if(data[i]){
                y++;
                var k = y - 1;
                finalprice[k] = [];
                var attr = guige(data[i]);
                var price = addressprice[i].price;
                
                htmld += '<tr>';
                htmld += '<th>'+y+'</th>';
                htmld += '<td id="edit">'+data[i].id+'</td>';
                htmld += '<td>'+data[i].name+'</td>';
                htmld += '<td>'+attr+'</td>';
                htmld += '<td>'+data[i].count+'</td>';
                countes += parseInt(data[i].count);
                if(shengfen[0]){
                    for (var z = 0; z < shengfen.length; z++) {
                        if(fatherprivious){
                            var tt = 0;
                            for (var t = 0; t < fatherprivious.length; t++) {
                                if(fatherprivious[t] == shengfen[z]){
                                    tt = 1;
                                }
                            }
                            if(tt == 0){
                                var x = 0;
                                if(addressprice[i].price != null && addressprice[i].price[0]){
                                    for (var m = 0; m < price.length; m++) {

                                        if(price[m].province == shengfen[z]){
                                                htmld += '<td>'+(price[m].avg).toFixed(1)+'</td>';
                                                allprice[z] += price[m].avg*data[i].count;
                                                finalprice[k][finalprice[k].length] = price[m].avg;
                                        }else{
                                            ++x;
                                        }
                                        if(x == price.length){
                                            htmld += '<td>0</td>';
                                            finalprice[k][finalprice[k].length] = 0;
                                        }
                                    }
                                }else{
                                    htmld += '<td>0</td>';
                                    finalprice[k][finalprice[k].length] = 0;
                                }
                            }
                        }else{

                            var x = 0;
                            if(addressprice[i].price != null && addressprice[i].price[0]){
                                for (var m = 0; m < price.length; m++) {

                                    if(price[m].province == shengfen[z]){
                                            htmld += '<td>'+(price[m].avg).toFixed(1)+'</td>';
                                            allprice[z] += price[m].avg*data[i].count;
                                            finalprice[k][finalprice[k].length] = price[m].avg;
                                    }else{
                                        ++x;
                                    }
                                    if(x == price.length){
                                        htmld += '<td>0</td>';
                                        finalprice[k][finalprice[k].length] = 0;
                                    }
                                }
                            }else{
                                htmld += '<td>0</td>';
                                finalprice[k][finalprice[k].length] = 0;
                            }
                            
                        }
                    }
                }
                if(cities[0]){
                    for (var z = 0; z < shengfen.length; z++) {
                        for (var q = 0; q < cities.length; q++) {
                            if(pricescity[shengfen[z]][i] != 'undefined'){
                                if(pricescity[shengfen[z]][i] != undefined){
                                    var pricesss = pricescity[shengfen[z]][i][cities[q]];
                                    if(pricesss){
                                        htmld += '<td>'+pricesss.toFixed(1)+'</td>';
                                        finalprice[k][finalprice[k].length] = pricesss;
                                        allareaprice[q] += pricesss*data[i].count;
                                    }else if(sohard[shengfen[z]][cities[q]]){
                                        htmld += '<td>0</td>';
                                        finalprice[k][finalprice[k].length] = 0;
                                    }
                                }else{
                                    htmld += '<td>0</td>';
                                    finalprice[k][finalprice[k].length] = 0;
                                }
                            }else{
                                htmld += '<td>0</td>';
                                finalprice[k][finalprice[k].length] = 0;
                            }
                        }
                    }
                }
                htmld += '<tr>';
            }
        }
        htmld += '<tr><th id="r2" colspan=4>合计:</th><td id="r0">'+countes+'</td>';
        if(shengfen[0]){
            for (var i = 0; i < shengfen.length; i++) {
                if(shengfen[i]){
                    var tt = 0;
                    if(fatherprivious){
                        for (var t = 0; t < fatherprivious.length; t++) {
                            if(fatherprivious[t] == shengfen[i]){
                                tt = 1;
                            }
                        }
                    }
                    if(tt == 0){
                        htmld += '<td id="r0">'+allprice[i].toFixed(0);+'</td>';
                    }
                }
            }
        }

        if(cities[0]){
            for (var i = 0; i < cities.length; i++) {
                htmld += '<td id="r0">'+allareaprice[i].toFixed(0);+'</td>';
            }   
        }
        $('#attributeshow').html();
        $('#attributeshow').html(htmld);
    }


    function final_deal(){
        var province = $(".province").val();
        var city = $(".city").val();
        var area = $(".area").val();
        if(province) detailed_address = province;
        if(city) detailed_address += '.'+city;
        if(area) detailed_address += '.'+area;
        var finalallprice = [];
        var as = 0;
        for (var x = 0; x < data.length; x++) {
            if(data[x]){
                finalallprice[as] = {};
                finalallprice[as].id = data[x].id;
                as++;
            }
        }
        
        if(finalkey){
            for (var x = 0; x < finalprice.length; x++) {
                for (var i = 0; i < finalkey.length; i++) {
                    finalallprice[x][finalkey[i]] = finalprice[x][i];
                }
            }
            var newdata = 0;
            var typedata = [];
            var typeaddressprices = finalallprice;
            for (var i = 1; i < 12; i++) {
                for (var x = 0; x < data.length; x++) {
                    if((data[x].type == i) && data[x]){
                        typedata[newdata] = data[x];
                        newdata++;
                    }
                }
            }
        }else{
            var newdata = 0;
            var typedata = [];
            var typeaddressprices = 1;
            for (var i = 1; i < 12; i++) {
                for (var x = 0; x < data.length; x++) {
                    if((data[x].type == i) && data[x]){
                        typedata[newdata] = data[x];
                        newdata++;
                    }
                }
            }
        }   
            datas = JSON.stringify(typedata);
            addresspricess = JSON.stringify(typeaddressprices);
    }

    // 历史清单
    function loadHistoryorder(){
        $.cxSelect.defaults.url = 'js/chinaarea.min.json';
        $.getJSON('/com/order_index_search.php',{userid:user.userid},function(json){
            if(json){
                var address = json[json.length-1].address;
                if(address != 0){
                    var orderaddress = address.split('.');
                    if(orderaddress[0]) $('.province').attr('data-value',orderaddress[0]);
                    if(orderaddress[1]) $('.city').attr('data-value',orderaddress[1]);
                    if(orderaddress[2]) $('.area').attr('data-value',orderaddress[2]);
                }else{
                    $('.province').attr('data-value','北京市');
                    $('.city').attr('data-value','通州区');
                }

                var history_order = '';
                for (var i = 0; i < json.length; i++) {
                    history_order += '<div class="history_order_contents">';    
                    history_order += '<div class="ordername">'+json[i].ordername+'</div>';  
                    history_order += '<div class="ordertime">'+json[i].time+'</div>';      
                    history_order += '<input type="hidden" class="history_orderid" value="'+json[i].id+'">'; 
                    history_order += '<input type="hidden" class="history_orderaddress" value="'+json[i].address+'">'; 
                    history_order += '<div class="edit" style="display:none"><div class="copy">另存为</div><div class="delete">删除</div></div>';    
                    history_order += '</div>';  
                }
                $('#history_contents').html(history_order); 
            }
        });
        $('#tree_arrive_address_name').cxSelect({
            selects: ['province', 'city', 'area']
        });
    }

    function showhistoryorder(json){
        if(json[0] != undefined){
            var address_price = [];
            for (var i = 0; i < json.length; i++) {
                address_price[i] = json[i].address_price;            
            }
            
            var pricees = [];
            var addresspricees = [];
            for (var i = 0; i < address_price.length; i++) {
                if(address_price[i] != undefined){
                    address_price[i] = address_price[i].split(',');
                    pricees[i] = [];
                    for (var x = 0; x < address_price[i].length; x++) {
                        address_price[i][x] = address_price[i][x].split(':');
                        pricees[i][address_price[i][x][0]] = address_price[i][x][1];
                        addresspricees[x] = address_price[i][x][0];
                    }
                }
            }
        }
        
        var order_content = '<caption><h1>'+ordername+'</h1></caption><tr id="header"><th id="r0">序号</th><th id="r4">编号</th><th id="r1">名称</th><th id="r2">规格</th><th id="r1">数量</th>';
        if(json[0] != undefined){
            for (var i = 0; i < addresspricees.length; i++) {
                if(addresspricees[i]){
                    order_content += '<th id="r1">'+addresspricees[i]+'</th>';
                    
                }
            }
            var history_order_total = [];
            for (var x = 0; x < addresspricees.length; x++) {
                history_order_total[x] = 0;
            }
        }
        order_content += '</tr>';
        var counts = 0;
        for (var i = 0; i < json.length; i++) {
            var attr = attributes_show(json[i]);
            order_content += '<tr>';
            order_content += '<th>'+(1+i)+'</th>';
            order_content += '<td id="edit">'+json[i].id+'</td>';
            order_content += '<td>'+json[i].name+'</td>';
            order_content += '<td>'+attr+'</td>';
            order_content += '<td>'+json[i].count+'</td>';
            if(json[0].address_price){
                for (var x = 0; x < addresspricees.length; x++) {
                    if(addresspricees[x]){
                        order_content += '<td>'+pricees[i][addresspricees[x]]+'</td>';
                        history_order_total[x] += parseInt(pricees[i][addresspricees[x]])*parseInt(json[i].count);
                    }
                }
            }
            counts += json[i].count;
            order_content += '</tr>';
        }
        order_content += '<tr><th id="r2" colspan=4>合计:</th><td id="r1">'+counts+'</td>';
        if(json[0] != undefined){
            for (var x = 0; x < addresspricees.length; x++) {
                if(addresspricees.length > 0){
                    if(history_order_total[x]){
                        order_content += '<td>'+history_order_total[x]+'</td>';
                    }else{
                        order_content += '<td>0</td>';
                    }
                }
            }
        }
        order_content += '</tr>';

        $('#attributeshow').html();
        $('#attributeshow').html(order_content);
    }
    
    $('#history_contents').on("click",'.ordername',function(){
        ordername = $(this).html();
        var orderid = $(this).parents('.history_order_contents').find('.history_orderid').val();
        var horderaddress = $(this).parents('.history_order_contents').find('.history_orderaddress').val();
        
        if((horderaddress != 0) && (horderaddress != 'null')){
            var orderaddress = horderaddress.split('.');
            if(orderaddress[0] != 'null'){
                $('#tree_arrive_address_name input[name="province"]').val(orderaddress[0]);
            }else{
                $('#tree_arrive_address_name input[name="province"]').val('省');
            }
            if(orderaddress[1] != 'null'){
                $('#tree_arrive_address_name input[name="city"]').val(orderaddress[1]); 
            }else{
                $('#tree_arrive_address_name input[name="city"]').val('市');
            }
            if(orderaddress[2] != 'null'){
                $('#tree_arrive_address_name input[name="area"]').val(orderaddress[2]); 
            }else{
                $('#tree_arrive_address_name input[name="area"]').val('县'); 
            }
        }else{
            $('#tree_arrive_address_name input[name="province"]').val('省');
            $('#tree_arrive_address_name input[name="city"]').val('市');
            $('#tree_arrive_address_name input[name="area"]').val('县');
        }

        $.getJSON('/com/order_search.php',{orderid:orderid,userid:user.userid},function(json){
            showhistoryorder(json);
            $('.sheng').hide();
        });
    });

    $('#history_contents').on("click",'.delete',function(){
        var orderid = $(this).parents('.history_order_contents').find('.history_orderid').val();
        var hidden = $(this);
        $.get('/com/order_delete.php',{orderid:orderid,userid:user.userid},function(json){
            hidden.parents('.history_order_contents').hide();
        });
    });

    $('#history_contents').on("click",'.copy',function(){
        addressprice = [];
        historybutn = 0;
        $.getJSON('/com/order_temp_deletepc.php',{userid:user.userid,order:'-1'},function(json){
        });
        var orderid = $(this).parents('.history_order_contents').find('.history_orderid').val();
        $.getJSON('/com/order_search.php',{orderid:orderid,userid:user.userid},function(json){
            var history_datas = JSON.stringify(json);
            $.getJSON('/com/order_temp_adds.php',{data:history_datas},function(json){
            });
            data = [];
            provinces = [];
            addressprice = [];
            for (var x = 0; x < json.length; x++) {
                data[x] = {};
                for (var key in json[x]) {
                    var dictionaryattributes = ['trunk_diameter','ground_diameter','pot_diameter','crown','plant_height','branch_length','bough_length','branch_point_height','branch_number','bough_number',"age",'plant_height_cm','crown_cm','substrate'];
                    for (var i = 0; i < dictionaryattributes.length; i++) {
                        
                        if(key == dictionaryattributes[i]){
                            data[x][key] = json[x][key].split(',');
                            var attr = attributes_show(json[x]);
                        }
                    }
                }
                data[x]['id'] = json[x]['id'];
                data[x]['name'] = json[x]['name'];
                data[x]['count'] = json[x]['count'];
                data[x]['type'] = json[x]['type'];
                data[x]['typename'] = json[x]['typename'];
                data[x]['unit'] = json[x]['unit'];
                data[x]['userid'] = json[x]['userid'];
            }
            j = data.length;
            $.getJSON('/com/search_price_batch.php',{data:JSON.stringify(data)},function(json){
                for (var i = 0; i < json.length; i++) {
                    provinces[i] = [];
                    addressprice[i] = {};
                    for (var y = 0; y < data.length; y++) {
                        if(data[y].id == json[i].id){
                            addressprice[i].id = json[i].id;
                            if(json[i].price){
                                var p = 0;
                                addressprice[i].price = [];
                                for (var z = 0; z < json[i].price.length; z++) {
                                    // if(json[i].price[z].total >= data[y].count){
                                        addressprice[i].price[p] = json[i].price[z];
                                        provinces[i][p] = json[i].price[z].province;
                                        p++;
                                    // }
                                }
                            }else{
                                addressprice[i].price = [];
                                provinces[i] = '';
                            }
                        }
                    }
                }
                var haves = [''];
                for (var x = 0; x < provinces.length; x++) {
                    for (var z = 0; z < provinces[x].length; z++) {
                        var y = 0;
                        for (var i = 0; i < haves.length; i++) {
                            if(haves[i] != provinces[x][z]){
                                ++y;
                            }
                            if(y == haves.length){
                                haves[haves.length] = provinces[x][z];
                            }
                        }
                    }
                }   
                // 显示交集省份
                $('.sheng').hide();
                $('.tree_arrive_address_citys').hide();
                $('input[type="checkbox"]').prop("checked",false);
                for (var i = 0; i < haves.length; i++) {
                    $('#ads input[type="checkbox"][value="'+haves[i]+'"]').parent().show();
                }   

                cities = '';
                fatherprivious = '';
                pricescity = [];
                sohard = [];
                $('#label1').css('background','#ccc');
                $('#label2').css('background','#fff');
                $('#submit_button').show();
                $('#tree_arrive_aaddress').show();
                $('#tree_arrive_address_city').show();
                $('#attributein').show();
                $('#history').hide();
                $('#attributein input').val('');
                $('.cxselect').show();
                $('.hideform').hide();
                hideattribute();
                $('#add').html('添加');
                $('#reset').html('清空');
                showprice();
                n = -1;
            });
        });
    });

    function searchhistoryorder(){
        var key_name = $('#key_name').val();
        var key_area = $('#key_area').val();
        var demo = $('#demo').val();
        var key_time2 = $('#key_time2').val();
        $.getJSON('/com/order_index_search.php',{area:key_area,name:key_name,time1:demo,time2:key_time2,userid:user.userid},function(json){
            $('#history_contents').html(''); 
            if(json){
                var history_order = '';
                for (var i = 0; i < json.length; i++) {
                    history_order += '<div class="history_order_contents">';    
                    history_order += '<div class="ordername">'+json[i].ordername+'</div>';  
                    history_order += '<div class="ordertime">'+json[i].time+'</div>';      
                    history_order += '<input type="hidden" class="history_orderid" value="'+json[i].id+'">';
                    history_order += '<input type="hidden" class="history_orderaddress" value="'+json[i].address+'">';    
                    history_order += '<div class="edit" style="display:none"><div class="copy">另存为</div><div class="delete">删除</div></div>'; 
                    history_order += '</div>';  
                }
                $('#history_contents').html(history_order); 
            }
        }); 
    }

    $(function(){
        laydate({
             elem: '#demo'
          })
    });

    
    $('#ads').on('change','.sheng',function(){
        var areahtml = '';
        var shengfen = '';
        $('#ads input:checkbox:checked').each(function() {
            shengfen += $(this).val()+',';
        });
        if(shengfen.length > 0){
            shengfen = shengfen.substring(0,shengfen.length-1);
            shengfen = shengfen.split(',');
            for (var i = 0; i < shengfen.length; i++) {
                    var citys = haveareacity(shengfen[i]);
                    if(citys){
                        areahtml += '<div class="tree_arrive_address_citys">';
                        areahtml += '<div class="area_city">'+shengfen[i]+':</div>';
                        areahtml += '<div class="area_city_name">';
                        sohard[shengfen[i]] = [];
                        for (var x = 0; x < citys.length; x++) {
                            areahtml += '<label class="city_bn"><input type="checkbox" value="'+citys[x]+'">'+citys[x]+'</label>';
                            sohard[shengfen[i]][citys[x]] = 1;
                        }
                        areahtml += '</div>';
                        areahtml += '</div>';
                    }
            }
            $('#tree_arrive_address_city').html(areahtml);
        }else{
            $('#tree_arrive_address_city').html('');
        }
        if(cities != ''){
            for (var i = 0; i < cities.length; i++) {
                $('input[value='+cities[i]+']').attr('checked','checked');
            }
        }
        showprice();
    });
    
    $('#tree_arrive_address_city').on('change','.city_bn',function(){
        var fouk = '';
        cities = '';
        $('#tree_arrive_address_city input:checkbox:checked').each(function() {
            cities += $(this).val()+',';
            fouk += $(this).parents('.tree_arrive_address_citys').find('.area_city').html();
        });
        if(cities.length > 0){
            cities = cities.substring(0,cities.length-1);
            cities = cities.split(',');
        }
        if(fouk.length > 0){
            fouk = fouk.substring(0,fouk.length-1);
            fouk = fouk.split(':');
        }
        fatherprivious = fouk;
        showprice();
    });
    
    function haveareacity(same){
        var areacity = '';
        pricescity[same] = [];
        for (var i = 0; i < addressprice.length; i++) {
            if(addressprice[i]){
                pricescity[same][i] = [];
                var areaprice = addressprice[i].price;
                if(areaprice){
                    for (var x = 0; x < areaprice.length; x++) {
                        if(areaprice[x].province == same){
                            var areacitys = areaprice[x].city;
                            for (var y = 0; y < areacitys.length; y++) {
                                areacity += areacitys[y].city+'.';
                                pricescity[same][i][areacitys[y].city] = areacitys[y].avg;
                            }
                        }
                    } 
                }else{
                    pricescity[same][i] = 0;
                }
            }
        }

        areacity = areacity.substring(0,areacity.length-1);
        areacity = areacity.split('.');
        var zsareacity = [];
        for (var i = 0; i < areacity.length; i++) {
            var y = 0;
            if(zsareacity.length == 0){
                zsareacity[0] = areacity[i];
            }else{
                for (var x = 0; x < zsareacity.length; x++) {
                    if(areacity[i] != zsareacity[x]){
                        y++;
                    }
                    if(y == zsareacity.length){
                        zsareacity[zsareacity.length] = areacity[i];
                    }
                        
                }
            }
        }
        return zsareacity;
    }



/*******************绑定input button city document 事件***************************/
    
    function bindInputEvent ()  {
        $('#attributein input:text:first').focus();
        // 名称回车键
        $('#attributein input:text:first').bind('keydown', function (e) {
            var key = e.which;
            if (key == 13) {
                zhaoname(); 
            }
        });
        $('#attributein  input:text').bind('keydown', function (e) {
            var key = e.which;
            if (key == 13) {
                e.preventDefault();
                var nxtIdx = $('#attributein input:text').index(this) + 1;
                if(nxtIdx < 17){
                    while($("#attributein :input:text:eq(" + nxtIdx + ")").is(':visible') == false && nxtIdx < 17){
                        nxtIdx = nxtIdx + 1;
                    }
                    $("#attributein :input:text:eq(" + nxtIdx + ")").focus();
                    if(nxtIdx == 17)toadd();
                }else{
                    toadd();
                }
            }
        });

        $('#history  input:text').bind('keydown', function (e) {
            var key = e.which;
            if (key == 13) {
                e.preventDefault();
                var nxtIdx = $('#history input:text').index(this) + 1;
                if(nxtIdx < 2){
                    $("#history :input:text:eq(" + nxtIdx + ")").focus();
                }
            }
        });

        
        $('#order_name_button  input:text').bind('keydown', function (e) {
            var key = e.which;
            if (key == 13) {
                e.preventDefault();
                var nxtIdx = $('#order_name_button input:text').index(this) + 1;
                if(nxtIdx = 2){
                    final_deal();
                    var order_name = $('#order_name').val();
                    $.get('/com/order_add.php',{uid:user.userid, data:datas, addressprices:addresspricess,useraddress:detailed_address,ordername:order_name},function(json){    
                        loadHistoryorder();
                        alert('成功存入我的清单!');
                        data = [];
                        addressprice = [];
                        $('input[type="checkbox"]').prop("checked",false);
                        cities = '';
                        fatherprivious = '';
                        pricescity = [];
                        sohard = [];
                        $('#tree_arrive_address_city').html('');
                        $('.sheng').css('display','none');
                        provinces = [];
                        showprice();
                        $('.sheng').hide();
                    });
                    button_ordernumber = 0;
                }
            }
        });


    }
    
    function bindButtonEvent () {

        // 添加
        $('#add').click(function(){
            toadd();
        });

        // 重置填空
        $('#reset').click(function(){
            reset();
        });

        // 搜索名称
        $('#key_search').click(function(){
            searchhistoryorder();
        });

        $('#key_reset').click(function(){
            $('#history input').val('');
        });


        // 提交预算
        $('#deal').click(function(){
            $('.alertordername').show();
            button_ordernumber = 1;
        });

        $('#myorder').click(function(){
            $('.alertordername').show();
            button_ordernumber = 2;
        });

        $('#join_order').click(function(){
            $('.alertordername').show();
            button_ordernumber = 3;
        });
        
        $('#order_name_button_reset').click(function(){
            $('.alertordername').hide();
            $('#order_name').val('');
            button_ordernumber = 0;
        })
        
        $('#order_name_button').click(function(){
            final_deal();
            var order_name = $('#order_name').val();
            $('.alertordername').hide();
            if(button_ordernumber == 1){
                window.location = '/excel.php?uid='+user.userid+'&data='+datas+'&addressprices='+addresspricess+'&useraddress='+detailed_address+'&ordername='+order_name;
                button_ordernumber = 0;
            }else if(button_ordernumber == 2){
                window.location = '/require_list.php?uid='+user.userid+'&data='+datas+'&addressprices='+addresspricess+'&useraddress='+detailed_address+'&ordername='+order_name;
                button_ordernumber = 0;
            }else if(button_ordernumber == 3){
                $.get('/com/order_add.php',{uid:user.userid, data:datas, addressprices:addresspricess,useraddress:detailed_address,ordername:order_name},function(json){    
                    loadHistoryorder();
                    alert('成功存入我的清单!');
                    data = [];
                    addressprice = [];
                    $('input[type="checkbox"]').prop("checked",false);
                    cities = '';
                    fatherprivious = '';
                    pricescity = [];
                    sohard = [];
                    $('#tree_arrive_address_city').html('');
                    $('.sheng').css('display','none');
                    provinces = [];
                    showprice();
                    $('.sheng').hide();
                });
                button_ordernumber = 0;
            }
        });

        $('#label1').click(function(){
            $('#label1').css('background','#ccc');
            $('#submit_button').show();
            $('#tree_arrive_aaddress').show();
            $('#tree_arrive_address_city').show();
            $('#label2').css('background','#fff');
            $('#attributein').show();
            $('#history').hide();
            $('#attributeshow').html('');
            $('#attributein input').val('');
            hideattribute();
            $('#add').html('添加');
            $('#reset').html('清空');
            $('.cxselect').show();
            $('.hideform').hide();
            showprice();
            n = -1;
        });
        $('#label2').click(function(){
            $('#label2').css('background','#ccc');
            $('#label1').css('background','#fff');
            $('#submit_button').hide();
            $('#tree_arrive_aaddress').hide();
            $('#tree_arrive_address_city').hide();
            $('#tree_arrive_address_name input').val('');
            $('#history').show();
            $('#attributein').hide();
            $('.cxselect').hide();
            $('.hideform').show();
            $('#attributeshow').html('<caption><h1>历史清单</h1></caption><tr id="header"><th id="r0">序号</th><th id="r1">编号</th><th id="r0">名称</th><th id="r2">规格</th><th id="r0">数量</th>');
            $('.sheng').hide();
            n = -1;
        });

        $('#history_contents').on("mouseover",'.history_order_contents',function() {
            $(this).css('background','#eee');
            $(this).siblings().css('background','#fff');
            $(this).find('.edit').show();
            $(this).find('.ordertime').hide();
        });
        $('#history_contents').on("mouseout",'.history_order_contents',function() {
            $(this).find('.ordertime').show();
            $(this).css('background','#fff');
            $(this).find('.edit').hide();
        });
    }

    function bindDocumentClickCancleModify() {
        $(document).click(function(e) { 
            if(buttomnum > -1){
              var ss = $(e.target).parents('#fatherresetinput:first').attr('id');  
              if(ss != 'fatherresetinput' && ss != 'fatherresetinput'){
                buttomnum = -1;
                $('#attributeshow tr').css('background','#ffffff');
                $('#header').css('background-color','#cccccc');
                $('#attributein input').val('');
                hideattribute();
                $('#add').html('添加');
                $('#reset').html('清空');
              }   
            }
        });
    }

    if (user) {
        loadHistoryData();
        loadaddress();
        loadHistoryorder();
        bindInputEvent();
        bindButtonEvent();
        bindDocumentClickCancleModify();
    } else {
        login();
    }

</script>

</body>
</html>

